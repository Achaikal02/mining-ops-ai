==================================================================================
 INSTRUKSI - PROYEK MINING VALUE CHAIN OPTIMIZATION 
==================================================================================
Tanggal: 13 November 2025
Dari: Haikal (Machine Learning Engineer)
Untuk: Tim Back-End (BE) & Front-End (FE)

Dokumen ini berisi instruksi teknis lengkap untuk setup, deployment,
dan konsumsi API "Otak" AI yang telah selesai dikembangkan.

---
ARSITEKTUR FINAL:
---
Sistem ini adalah "Simulasi Hybrid" yang berjalan di server:
1.  Menggunakan SimPy untuk mengelola antrian (bottleneck) secara dinamis.
2.  Menggunakan 3 Model ML (.joblib) yang dilatih dari data nyata untuk memprediksi
    BBM, Muatan, dan Probabilitas Insiden.
3.  Menggunakan data kalibrasi (rata-rata) untuk durasi siklus (hauling, loading, dll).
4.  Menggunakan OLLAMA (llama3:8b) sebagai chatbot, sehingga 100% LOKAL dan
    tidak ada data sensitif (strategi/profit) yang dikirim ke internet.

Sistem ini memiliki dua agen:
1.  AGEN STRATEGIS: Menjalankan simulasi hybrid untuk menemukan 3 strategi terbaik.
2.  AGEN CHATBOT: Menjawab pertanyaan lanjutan HANYA tentang 3 strategi tersebut.

==================================================================================
BAGIAN 1: INSTRUKSI UNTUK TIM BACK-END (DEPLOYMENT)
==================================================================================

Tugas Anda adalah membuat `api.py` berjalan sebagai service di server.

---
CHECKLIST DEPLOYMENT SERVER:
---

1.  SETUP SERVER OLLAMA (WAJIB):
    -   Instal Ollama di server (dari ollama.com).
    -   Pastikan server Ollama berjalan (default di `http://localhost:11434`).
    -   Tarik model LLM yang kita gunakan. Buka terminal server dan jalankan:
        >> ollama pull llama3:8b
    -   Pastikan model sudah ada dengan menjalankan:
        >> ollama list

2.  DEPLOY PAKET FILE:
    -   Salin seluruh folder proyek ke server, dengan struktur folder yang WAJIB seperti ini:

        / (Folder Proyek Utama)
        |-- api.py          <-- (File ini yang akan Anda jalankan)
        |-- simulator.py    <-- (File "otak" yang diimpor oleh api.py)
        |-- requirements.txt
        |
        |-- data/
        |   |-- trucks.csv
        |   |-- excavators.csv
        |   |-- operators.csv
        |   |-- road_segments.csv
        |   |-- maintenance_logs.csv
        |
        |-- models/
            |-- model_fuel.joblib
            |-- model_load_weight.joblib
            |-- model_delay_probability.joblib
            |-- numerical_columns.json
            |-- categorical_columns.json

3.  SETUP LINGKUNGAN PYTHON:
    -   Sangat disarankan menggunakan virtual environment:
        >> python -m venv venv
        >> source venv/bin/activate  (atau .\venv\Scripts\activate di Windows)
    -   Instal semua dependensi dari requirements:
        >> pip install -r requirements.txt
    -   (Ini akan menginstal fastapi, uvicorn, pandas, simpy, joblib, scikit-learn, ollama).

4.  JALANKAN SERVER API:
    -   Dari folder proyek utama, jalankan Uvicorn:
        >> uvicorn api:app --host 0.0.0.0 --port 8000
    -   `--host 0.0.0.0` penting agar API bisa diakses dari jaringan (bukan hanya localhost).
    -   `--port 8000` bisa diganti sesuai kebutuhan (misal: 8080).

5.  TESTING & HANDOFF URL:
    -   Pastikan API berjalan dengan mengakses `http://[IP_SERVER_ANDA]:8000/docs` dari browser Anda.
    -   Berikan URL ini (misal: `http://10.0.1.50:8000`) kepada Tim Front-End.

==================================================================================
BAGIAN 2: INSTRUKSI UNTUK TIM FRONT-END (KONSUMSI API)
==================================================================================

Tugas Anda adalah "berbicara" dengan API yang telah disiapkan oleh Tim BE.
Anda akan memanggil 2 endpoint secara berurutan.

---
ALUR PENGGUNA (USER FLOW) APLIKASI:
---

STEP 1: USER MEMASUKKAN KONDISI
-   User memilih input dari UI (dropdown, text field, dll) untuk:
    1.  **Kondisi Tetap** (misal: Cuaca 'Hujan Deras', Jalan 'POOR', Rute 'Pit 1 ke Stockpile').
    2.  **Variabel Keputusan** (misal: Alokasi Truk [5, 10, 15], Jml Excavator [1, 2]).
    3.  **(OPSIONAL) Parameter "What-If"** (misal: User mengedit Harga Solar menjadi 20000).

STEP 2: FE MEMANGGIL AGEN STRATEGIS (ENDPOINT 1)
-   Saat user menekan "Cari Rekomendasi", aplikasi Anda mengirim permintaan `POST` ke:
-   URL: `http://[IP_SERVER_BE]:8000/get_top_3_strategies`
-   Body JSON harus sesuai kontrak di BAGIAN 3. Anda *harus* mengirim 'fixed_conditions' dan 'decision_variables'. 'financial_params' bersifat opsional.

STEP 3: FE MENERIMA & MENAMPILKAN DATA
-   API akan merespons (mungkin butuh 5-10 detik, karena ini simulasi berat) dengan JSON:
    { "top_3_strategies": [ {...}, {...}, {...} ] }
-   TUGAS PENTING: Anda harus **menyimpan** array `top_3_strategies` ini di *state* aplikasi Anda. Kita sebut ini `KONTEKS_CHAT`.
-   TUGAS FE: Render data ini ke dalam 3 "kontainer" atau "kartu" (sesuai desain UI/UX). Anda memiliki kontrol penuh atas tampilan. Gunakan `ESTIMASI_PROFIT_SHIFT` untuk mengurutkan.
    -   Kontainer 1: "REKOMENDASI UTAMA" (array[0])
    -   Kontainer 2: "PILIHAN EFISIEN" (array[1])
    -   Kontainer 3: "PILIHAN ALTERNATIF" (array[2])
-   **Chatbot (Ollama) BELUM dipanggil di tahap ini.**

STEP 4: USER BERTANYA DI CHATBOX
-   User melihat 3 kontainer tadi dan mengetik pertanyaan lanjutan (misal: "Kenapa Strategi 1 lebih untung?").

STEP 5: FE MEMANGGIL AGEN CHATBOT (ENDPOINT 2)
-   Saat user menekan "Kirim" di chat, aplikasi Anda mengirim permintaan `POST` ke:
-   URL: `http://[IP_SERVER_BE]:8000/ask_chatbot`
-   Body JSON untuk panggilan ini **HARUS** berisi dua hal:
    1.  `pertanyaan_user`: String pertanyaan dari user.
    2.  `top_3_strategies_context`: Variabel `KONTEKS_CHAT` yang Anda simpan di STEP 3.

STEP 6: FE MENAMPILKAN JAWABAN CHAT
-   API akan merespons dengan jawaban teks sederhana dari Ollama:
    { "jawaban_ai": "Strategi 1 lebih untung karena tonasenya jauh lebih tinggi..." }
-   Tugas FE: Tampilkan `jawaban_ai` ini di UI chat Anda.

==================================================================================
BAGIAN 3: KONTRAK API (REFERENSI TEKNIS)
==================================================================================

Gunakan halaman `/docs` (http://[IP_SERVER_BE]:8000/docs) sebagai referensi interaktif utama.

---
ENDPOINT 1: AGEN STRATEGIS
---
-   URL: `/get_top_3_strategies`
-   Method: `POST`
-   Request Body (Contoh "What-If"):
    {
      "fixed_conditions": {
        "weatherCondition": "Hujan Ringan",
        "roadCondition": "FAIR",
        "shift": "SHIFT_1",
        "target_road_id": "cmhsbjn8x02s2maft90hi31ty",
        "target_excavator_id": "cmhsbjpma05ddmaft5kv95dom"
      },
      "decision_variables": {
        "alokasi_truk": [5, 10],
        "jumlah_excavator": [1, 2]
      },
      "financial_params": {
        "HargaJualBatuBara": 800000,
        "HargaSolar": 20000,
        "BiayaPenaltiKeterlambatanKapal": 100000000
      }
    }
    
-   Request Body (Contoh "Default"):
    (Kirim JSON yang sama seperti di atas, tetapi HAPUS seluruh kunci "financial_params".
    Server akan otomatis menggunakan harga default).

-   Response Body (Sukses):
    {
      "top_3_strategies": [
        {
          "alokasi_truk": 10,
          "jumlah_excavator": 2,
          "weatherCondition": "Hujan Ringan",
          "roadCondition": "FAIR",
          "shift": "SHIFT_1",
          "target_road_id": "cmhsbjn8x02s2maft90hi31ty",
          "target_excavator_id": "cmhsbjpma05ddmaft5kv95dom",
          "Z_SCORE_PROFIT": 923805210.96228,
          "total_tonase": 1638.0,
          "total_bbm_liter": 1284.097046959087,
          "total_waktu_antri_jam": 3.6733333333333364,
          "jumlah_siklus_selesai": 60
        },
        { ... (Strategi 2) ... },
        { ... (Strategi 3) ... }
      ]
    }


---
ENDPOINT 2: AGEN CHATBOT
---
-   URL: `/ask_chatbot`
-   Method: `POST`
-   Request Body (Contoh):
    {
      "pertanyaan_user": "Berapa selisih profit antara strategi 1 dan 2?",
      "top_3_strategies_context": [
        { "Z_SCORE_PROFIT": 923805210.96, "alokasi_truk": 10, ... },
        { "Z_SCORE_PROFIT": 607445328.60, "alokasi_truk": 5, ... },
        { "Z_SCORE_PROFIT": 446725830.39, "alokasi_truk": 5, ... }
      ]
    }

-   Response Body (Sukses):
    {
      "jawaban_ai": "Selisih profit antara Strategi 1 dan Strategi 2 adalah sekitar 316 Juta IDR. Ini karena Strategi 1..."
    }